From c8dd6e32cc44cb1ac3267c4a5ece1eae5a4cff4c Mon Sep 17 00:00:00 2001
From: Steve Kondik <steve@cyngyn.com>
Date: Fri, 2 Jan 2015 14:47:25 -0800
Subject: [PATCH] Allow devices to not use hwdep calibration Some devices do
 not support this yet, so make it opt-outable

Change-Id: I7927ecc05fc7177e935f7b7af502a439c0e9524d
---
 hal/Android.mk         |  4 ++++
 hal/msm8974/platform.c | 10 +++++++++-
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/hal/Android.mk b/hal/Android.mk
index 0d8670a..48cc665 100644
--- a/hal/Android.mk
+++ b/hal/Android.mk
@@ -165,6 +165,10 @@ ifeq ($(strip $(AUDIO_FEATURE_PCM_IOCTL_ENABLED)),true)
     LOCAL_CFLAGS += -DPCM_IOCTL_ENABLED
 endif
 
+ifeq ($(strip $(AUDIO_FEATURE_DISABLED_HWDEP_CAL)),true)
+    LOCAL_CFLAGS += -DHWDEP_CAL_DISABLED
+endif
+
 LOCAL_COPY_HEADERS_TO   := mm-audio
 LOCAL_COPY_HEADERS      := audio_extn/audio_defs.h
 
diff --git a/hal/msm8974/platform.c b/hal/msm8974/platform.c
index 93b1775..2df8f38 100644
--- a/hal/msm8974/platform.c
+++ b/hal/msm8974/platform.c
@@ -35,7 +35,9 @@
 #include "voice_extn.h"
 #include "sound/compress_params.h"
:

diff --git a/hal/Android.mk b/hal/Android.mk
index 0d8670a..48cc665 100644
--- a/hal/Android.mk
+++ b/hal/Android.mk
@@ -165,6 +165,10 @@ ifeq ($(strip $(AUDIO_FEATURE_PCM_IOCTL_ENABLED)),true)
     LOCAL_CFLAGS += -DPCM_IOCTL_ENABLED
 endif
 
+ifeq ($(strip $(AUDIO_FEATURE_DISABLED_HWDEP_CAL)),true)
+    LOCAL_CFLAGS += -DHWDEP_CAL_DISABLED
+endif
+
 LOCAL_COPY_HEADERS_TO   := mm-audio
 LOCAL_COPY_HEADERS      := audio_extn/audio_defs.h
 
diff --git a/hal/msm8974/platform.c b/hal/msm8974/platform.c
index 93b1775..2df8f38 100644
--- a/hal/msm8974/platform.c
+++ b/hal/msm8974/platform.c
@@ -35,7 +35,9 @@
 #include "voice_extn.h"
 #include "sound/compress_params.h"
 #include "platform_parser.h"
+#ifndef HWDEP_CAL_DISABLED
 #include "sound/msmcal-hwdep.h"
+#endif
 
 #define SOUND_TRIGGER_DEVICE_HANDSET_MONO_LOW_POWER_ACDB_ID (100)
 
@@ -85,11 +87,13 @@
 #define AUDIO_PARAMETER_KEY_VOLUME_BOOST  "volume_boost"
 #define MAX_CAL_NAME 20
 
+#ifndef HWDEP_CAL_DISABLED
 char cal_name_info[WCD9XXX_MAX_CAL][MAX_CAL_NAME] = {
         [WCD9XXX_ANC_CAL] = "anc_cal",
         [WCD9XXX_MBHC_CAL] = "mbhc_cal",
         [WCD9XXX_MAD_CAL] = "mad_cal",
 };
+#endif
 
 enum {
        VOICE_FEATURE_SET_DEFAULT,
@@ -338,6 +342,8 @@ static int acdb_device_table[SND_DEVICE_MAX] = {
 
 #define DEEP_BUFFER_PLATFORM_DELAY (29*1000LL)
 #define LOW_LATENCY_PLATFORM_DELAY (13*1000LL)
+
+#ifndef HWDEP_CAL_DISABLED
 static int hw_util_open(int card_no)
 {
     int fd = -1;
@@ -422,7 +428,7 @@ static void audio_hwdep_send_cal(struct platform_data *plat_data)
     if (send_codec_cal(acdb_loader_get_calibration, fd) < 0)
         ALOGE("%s: Could not send anc cal", __FUNCTION__);
 }
-
+#endif
 
 
 static void set_echo_reference(struct audio_device *adev, bool enable)
@@ -717,7 +723,9 @@ void *platform_init(struct audio_device *adev)
     /* Read one time ssr property */
     audio_extn_ssr_update_enabled();
     audio_extn_spkr_prot_init(adev);
+#ifndef HWDEP_CAL_DISABLED
     audio_hwdep_send_cal(my_data);
+#endif
     return my_data;
 }
 
-- 
2.5.0

